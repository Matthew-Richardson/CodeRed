import arcpy
import os
from arcpy import env
from datetime import datetime

# Set environment
env.workspace = r"T:\Richardsonm\OEM_CodeRED"
env.overwriteOutput = True

# Temp shapefile output directory
temp_dir = r"T:\Richardsonm\OEM_CodeRED\temp"
if not arcpy.Exists(temp_dir):
    os.makedirs(temp_dir)

# Input feature class paths
point_fc = r"C:\Users\RichardsonMD\AppData\Roaming\Esri\ArcGISPro\Favorites\SQLDB4GIS.sde\EntGDB.SDE.AddressRelated\EntGDB.SDE.AddressPoints"
polygon_fc = r"C:\Users\RichardsonMD\AppData\Roaming\Esri\ArcGISPro\Favorites\SQLDB4GIS.sde\EntGDB.sde.VWPARCEL"

# Export to shapefiles (workaround for SDE errors)
point_shp = os.path.join(temp_dir, "AddressPoints.shp")
polygon_shp = os.path.join(temp_dir, "Parcels.shp")

arcpy.conversion.FeatureClassToFeatureClass(point_fc, temp_dir, "AddressPoints.shp")
arcpy.conversion.FeatureClassToFeatureClass(polygon_fc, temp_dir, "Parcels.shp")

# Step 1: Spatial Join
spatial_join_fc = os.path.join(temp_dir, "Temp_SpatialJoin.shp")
if arcpy.Exists(spatial_join_fc):
    arcpy.management.Delete(spatial_join_fc)

arcpy.analysis.SpatialJoin(
    target_features=point_shp,
    join_features=polygon_shp,
    out_feature_class=spatial_join_fc,
    join_type="KEEP_ALL",
    match_option="WITHIN"
)

# Step 2: Remove Unwanted Fields (shapefile field limit = 10 chars)
keep_fields = ["SITE_DR", "SITE_ST", "SITE_MD", "SITE_UNIT", "SITE_NUM", "LABEL_TYPE", "PROPERTY_A", "SITE_CITY", "SITE_ZIP", "STATE_CO"]
all_fields = [f.name for f in arcpy.ListFields(spatial_join_fc)]
drop_fields = [f for f in all_fields if f not in keep_fields and f not in ("FID", "Shape")]

# Delete unwanted fields
arcpy.management.DeleteField(spatial_join_fc, drop_fields)

# Step 3: Reproject and output as LPC_CodeRED_YYYYMMDD.shp
today_str = datetime.today().strftime("%Y%m%d")
output_name = f"LPC_CodeRED_{today_str}.shp"
final_output = os.path.join(env.workspace, output_name)
output_sr = arcpy.SpatialReference(4269)  # NAD83

if arcpy.Exists(final_output):
    arcpy.management.Delete(final_output)

arcpy.management.Project(spatial_join_fc, final_output, output_sr)

# Step 4: Add 'State' field and populate with 'CO'
state_field = "State"
if state_field not in [f.name for f in arcpy.ListFields(final_output)]:
    arcpy.management.AddField(final_output, state_field, "TEXT", field_length=2)

arcpy.management.CalculateField(
    in_table=final_output,
    field=state_field,
    expression="'CO'",
    expression_type="PYTHON3"
)

print("Processing complete. Final geolocator shapefile saved to:", final_output)
