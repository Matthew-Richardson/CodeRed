import arcpy
import os
from arcpy import env

# Set environment
env.workspace = r"T:\Richardsonm\OEM_CodeRED"
env.overwriteOutput = True

# Temp shapefile output directory
temp_dir = r"T:\Richardsonm\OEM_CodeRED\temp"
if not arcpy.Exists(temp_dir):
    os.makedirs(temp_dir)

# Input feature class paths
point_fc = r"C:\Users\RichardsonMD\AppData\Roaming\Esri\ArcGISPro\Favorites\SQLDB4GIS.sde\EntGDB.SDE.AddressRelated\EntGDB.SDE.AddressPoints"
polygon_fc = r"C:\Users\RichardsonMD\AppData\Roaming\Esri\ArcGISPro\Favorites\SQLDB4GIS.sde\EntGDB.sde.VWPARCEL"

# Export to shapefiles (workaround for SDE errors)
point_shp = os.path.join(temp_dir, "AddressPoints.shp")
polygon_shp = os.path.join(temp_dir, "Parcels.shp")

arcpy.conversion.FeatureClassToFeatureClass(point_fc, temp_dir, "AddressPoints.shp")
arcpy.conversion.FeatureClassToFeatureClass(polygon_fc, temp_dir, "Parcels.shp")

# Step 1: Spatial Join
spatial_join_fc = os.path.join(temp_dir, "Temp_SpatialJoin.shp")
if arcpy.Exists(spatial_join_fc):
    arcpy.management.Delete(spatial_join_fc)

arcpy.analysis.SpatialJoin(
    target_features=point_shp,
    join_features=polygon_shp,
    out_feature_class=spatial_join_fc,
    join_type="KEEP_ALL",
    match_option="WITHIN"
)

# Step 2: Remove Unwanted Fields (must use field names â‰¤10 characters for shapefiles)
keep_fields = ["SITE_DR", "SITE_ST", "SITE_MD", "SITE_UNIT", "SITE_NUM", "LABEL_TYPE", "PROPERTY_A", "SITE_CITY", "SITE_ZIP", "STATE_CO"]
all_fields = [f.name for f in arcpy.ListFields(spatial_join_fc)]
drop_fields = [f for f in all_fields if f not in keep_fields and f not in ("FID", "Shape")]

# Delete unwanted fields
arcpy.management.DeleteField(spatial_join_fc, drop_fields)

# Step 3: Reproject to GDB (avoid shapefile projection issues)
gdb_output = os.path.join(env.workspace, "Final_Geolocator_Input")
output_sr = arcpy.SpatialReference(4269)  # NAD83

if arcpy.Exists(gdb_output):
    arcpy.management.Delete(gdb_output)

arcpy.management.Project(spatial_join_fc, gdb_output, output_sr)

print("Processing complete. Final geolocator input saved to:", gdb_output)
